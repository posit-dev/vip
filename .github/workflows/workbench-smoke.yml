name: Workbench Smoke Tests

on:
  push:
    branches: [main]
  pull_request:
  schedule:
    - cron: "0 7 * * *" # daily at 7am UTC

permissions:
  contents: read
  checks: write

jobs:
  workbench-smoke:
    name: Smoke test against Workbench ${{ matrix.workbench-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        workbench-version: ${{ github.event_name == 'schedule' && fromJSON('["2024.09.0", "daily"]') || fromJSON('["2024.09.0"]') }}
    steps:
      - uses: actions/checkout@v4

      # Start Workbench in Docker
      - name: Start Workbench
        run: |
          docker run -d \
            --name workbench \
            -p 8787:8787 \
            -e RSP_LICENSE="${{ secrets.WORKBENCH_LICENSE }}" \
            rstudio/rstudio-workbench:${{ matrix.workbench-version }}

      # Create a PAM test user while the server is initialising
      - name: Create test user
        run: |
          timeout 180 bash -c '
            until docker exec workbench sh -c "true" 2>/dev/null; do sleep 3; done
          '
          docker exec workbench useradd -m -s /bin/bash rstudio
          docker exec workbench sh -c "echo 'rstudio:rstudio' | chpasswd"

      # Wait for the server health endpoint to respond
      - name: Wait for Workbench to be ready
        run: |
          timeout 180 bash -c \
            'until curl -sf http://localhost:8787/health-check; do sleep 5; done'

      # Resolve the actual Workbench version for unambiguous job records
      - name: Resolve Workbench version
        id: version
        run: |
          RESPONSE=$(curl -sf http://localhost:8787/api/server-info)
          VERSION=$(echo "${RESPONSE}" | jq -r '.version')
          if [ -z "${VERSION}" ] || [ "${VERSION}" = "null" ]; then
            echo "ERROR: Could not resolve Workbench version from server-info"
            echo "Response body: ${RESPONSE}"
            exit 1
          fi
          echo "Resolved Workbench version: ${VERSION}"
          echo "resolved=${VERSION}" >> "$GITHUB_OUTPUT"

      # Rename the check run so the job title shows the resolved version
      - name: Update job title with resolved version
        uses: actions/github-script@v7
        with:
          script: |
            const resolvedVersion = '${{ steps.version.outputs.resolved }}';
            const { data: { jobs } } = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });
            const currentJob = jobs.find(
              j => j.status === 'in_progress' && j.name.includes('${{ matrix.workbench-version }}')
            );
            if (currentJob) {
              await github.rest.checks.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                check_run_id: currentJob.id,
                name: `Smoke test against Workbench ${resolvedVersion}`,
              });
            }

      # Set up Python and install VIP
      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Install Playwright browsers
        run: uv run playwright install chromium

      # Generate vip.toml from Docker container outputs
      - name: Configure VIP for CI Workbench
        run: |
          cat > vip.toml << EOF
          [general]
          deployment_name = "CI Workbench"

          [workbench]
          enabled = true
          url = "http://localhost:8787"
          version = "${{ steps.version.outputs.resolved }}"

          [auth]
          provider = "password"
          username = "rstudio"
          password = "rstudio"
          EOF

      # Run the subset of tests that work against Docker Workbench
      - name: Run Workbench smoke tests
        run: |
          uv run pytest \
            tests/prerequisites/test_components.py \
            tests/workbench/test_auth.py \
            -v -k "workbench" \
            --vip-config=vip.toml \
            --junitxml=smoke-results.xml

      # Upload test results for debugging failures
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workbench-smoke-results-${{ steps.version.outputs.resolved }}
          path: smoke-results.xml

      # Write a rich job summary with test details and emoji
      - name: Write workflow summary
        if: always()
        run: |
          RESOLVED="${{ steps.version.outputs.resolved }}"
          WB_URL="http://localhost:8787"
          REQUESTED="${{ matrix.workbench-version }}"
          RUN_DATE=$(date -u '+%Y-%m-%d %H:%M UTC')
          {
            echo "## ðŸ§ª Workbench Smoke Tests â€” v${RESOLVED}"
            echo ""
            echo "| | |"
            echo "|---|---|"
            echo "| ðŸ·ï¸ **Requested version** | \`${REQUESTED}\` |"
            echo "| âœ… **Resolved version** | \`${RESOLVED}\` |"
            echo "| ðŸŒ **Workbench URL** | \`${WB_URL}\` |"
            echo "| ðŸ“… **Run date** | ${RUN_DATE} |"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"
          if [ -f smoke-results.xml ]; then
            TESTS=$(grep -oP '(?<=tests=")[^"]+' smoke-results.xml | head -1 || echo 0)
            FAILURES=$(grep -oP '(?<=failures=")[^"]+' smoke-results.xml | head -1 || echo 0)
            ERRORS=$(grep -oP '(?<=errors=")[^"]+' smoke-results.xml | head -1 || echo 0)
            SKIPPED=$(grep -oP '(?<=skipped=")[^"]+' smoke-results.xml | head -1 || echo 0)
            TESTS=${TESTS:-0}; FAILURES=${FAILURES:-0}; ERRORS=${ERRORS:-0}; SKIPPED=${SKIPPED:-0}
            PASSED=$(( TESTS - FAILURES - ERRORS - SKIPPED ))
            {
              echo "### ðŸ“Š Test Results"
              echo ""
              echo "| Result | Count |"
              echo "|--------|-------|"
              echo "| âœ… Passed | ${PASSED} |"
              echo "| âŒ Failed | ${FAILURES:-0} |"
              echo "| âš ï¸ Errors | ${ERRORS:-0} |"
              echo "| â­ï¸ Skipped | ${SKIPPED:-0} |"
              echo "| ðŸ“ **Total** | **${TESTS:-0}** |"
              echo ""
              if [ "${FAILURES:-0}" = "0" ] && [ "${ERRORS:-0}" = "0" ]; then
                echo "ðŸŽ‰ **All tests passed!**"
              else
                echo "ðŸ’¥ **Some tests failed â€” check the logs for details.**"
              fi
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "> âš ï¸ Test results file not found â€” tests may have been skipped." >> "$GITHUB_STEP_SUMMARY"
          fi

      # Stop and remove the Workbench container
      - name: Stop Workbench
        if: always()
        run: docker stop workbench && docker rm workbench
