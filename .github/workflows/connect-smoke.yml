name: Connect Smoke Tests

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read

jobs:
  connect-smoke:
    name: Smoke test against Connect ${{ matrix.connect-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        connect-version: ["2024.08.0", "release"]
    steps:
      - uses: actions/checkout@v4

      # Start Connect in Docker
      - name: Start Connect
        id: connect
        uses: posit-dev/with-connect@main
        with:
          version: ${{ matrix.connect-version }}
          license: ${{ secrets.CONNECT_LICENSE }}

      # Resolve the actual Connect version for unambiguous job records
      - name: Resolve Connect version
        id: version
        run: |
          VERSION=$(curl -sf \
            -H "Authorization: Key ${{ steps.connect.outputs.CONNECT_API_KEY }}" \
            "${{ steps.connect.outputs.CONNECT_SERVER }}/__api__/server_settings" \
            | jq -r '.version')
          if [ -z "${VERSION}" ] || [ "${VERSION}" = "null" ]; then
            echo "ERROR: Could not resolve Connect version from server_settings"
            exit 1
          fi
          echo "Resolved Connect version: ${VERSION}"
          echo "resolved=${VERSION}" >> "$GITHUB_OUTPUT"

      # Set up Python and install VIP
      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Install Playwright browsers
        run: uv run playwright install chromium

      # Generate vip.toml from with-connect outputs
      - name: Configure VIP for CI Connect
        run: |
          cat > vip.toml << EOF
          [general]
          deployment_name = "CI Connect"

          [connect]
          enabled = true
          url = "${{ steps.connect.outputs.CONNECT_SERVER }}"
          api_key = "${{ steps.connect.outputs.CONNECT_API_KEY }}"

          [auth]
          provider = "password"
          EOF

      # Run the subset of tests that work against Docker Connect
      - name: Run Connect smoke tests
        run: |
          uv run pytest \
            tests/prerequisites/test_components.py \
            tests/connect/test_auth.py \
            -v -k "reachable or api" \
            --vip-config=vip.toml \
            --junitxml=smoke-results.xml
        env:
          VIP_CONNECT_API_KEY: ${{ steps.connect.outputs.CONNECT_API_KEY }}

      # Upload test results for debugging failures
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: connect-smoke-results-${{ steps.version.outputs.resolved }}
          path: smoke-results.xml

      # Stop Connect
      - name: Stop Connect
        if: always()
        uses: posit-dev/with-connect@main
        with:
          stop: ${{ steps.connect.outputs.CONTAINER_ID }}
